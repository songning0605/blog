<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端依赖安全漏洞 | 前端进阶</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="系统性学习，打造完善的知识体系">
    <link rel="preload" href="/blog/assets/css/0.styles.5dc057b1.css" as="style"><link rel="preload" href="/blog/assets/js/app.d7b4ca64.js" as="script"><link rel="preload" href="/blog/assets/js/2.d2cb7039.js" as="script"><link rel="preload" href="/blog/assets/js/19.7ca76503.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.b6d45109.js"><link rel="prefetch" href="/blog/assets/js/11.02c66630.js"><link rel="prefetch" href="/blog/assets/js/12.569c81c8.js"><link rel="prefetch" href="/blog/assets/js/13.2933a416.js"><link rel="prefetch" href="/blog/assets/js/14.e8b9a8eb.js"><link rel="prefetch" href="/blog/assets/js/15.cc49f41e.js"><link rel="prefetch" href="/blog/assets/js/16.fcf94bc8.js"><link rel="prefetch" href="/blog/assets/js/17.212491a7.js"><link rel="prefetch" href="/blog/assets/js/18.aba42cee.js"><link rel="prefetch" href="/blog/assets/js/20.ef709027.js"><link rel="prefetch" href="/blog/assets/js/21.6dec212e.js"><link rel="prefetch" href="/blog/assets/js/22.2175430e.js"><link rel="prefetch" href="/blog/assets/js/23.72b7e27d.js"><link rel="prefetch" href="/blog/assets/js/24.1d369bec.js"><link rel="prefetch" href="/blog/assets/js/25.4a81ae13.js"><link rel="prefetch" href="/blog/assets/js/26.c516e806.js"><link rel="prefetch" href="/blog/assets/js/27.52b8ed02.js"><link rel="prefetch" href="/blog/assets/js/28.7200da10.js"><link rel="prefetch" href="/blog/assets/js/29.317911aa.js"><link rel="prefetch" href="/blog/assets/js/3.47a74f5f.js"><link rel="prefetch" href="/blog/assets/js/30.a92a3e89.js"><link rel="prefetch" href="/blog/assets/js/31.633db90e.js"><link rel="prefetch" href="/blog/assets/js/32.af4b30d4.js"><link rel="prefetch" href="/blog/assets/js/33.1a6245dc.js"><link rel="prefetch" href="/blog/assets/js/34.73a314bb.js"><link rel="prefetch" href="/blog/assets/js/35.67a47972.js"><link rel="prefetch" href="/blog/assets/js/36.b747b287.js"><link rel="prefetch" href="/blog/assets/js/37.c648cace.js"><link rel="prefetch" href="/blog/assets/js/38.30a84d00.js"><link rel="prefetch" href="/blog/assets/js/39.b63578f8.js"><link rel="prefetch" href="/blog/assets/js/4.3b6a7e49.js"><link rel="prefetch" href="/blog/assets/js/40.3a6f8db1.js"><link rel="prefetch" href="/blog/assets/js/41.9a72472f.js"><link rel="prefetch" href="/blog/assets/js/42.e28f36bb.js"><link rel="prefetch" href="/blog/assets/js/43.d9d88890.js"><link rel="prefetch" href="/blog/assets/js/44.424aa53b.js"><link rel="prefetch" href="/blog/assets/js/45.0556d798.js"><link rel="prefetch" href="/blog/assets/js/46.92a18e35.js"><link rel="prefetch" href="/blog/assets/js/47.56e9f1e4.js"><link rel="prefetch" href="/blog/assets/js/48.4869689c.js"><link rel="prefetch" href="/blog/assets/js/49.8b4ade4a.js"><link rel="prefetch" href="/blog/assets/js/5.bc6e1aa4.js"><link rel="prefetch" href="/blog/assets/js/6.46556db1.js"><link rel="prefetch" href="/blog/assets/js/7.63a358f8.js"><link rel="prefetch" href="/blog/assets/js/8.088f79f0.js"><link rel="prefetch" href="/blog/assets/js/9.6c4360fc.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.5dc057b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/favicon.png" alt="前端进阶" class="logo"> <span class="site-name can-hide">前端进阶</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/article/" class="nav-link router-link-active">
  文章目录
</a></div><div class="nav-item"><a href="http://www.conardli.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/ConardLi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/article/" class="nav-link router-link-active">
  文章目录
</a></div><div class="nav-item"><a href="http://www.conardli.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/ConardLi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/article/" aria-current="page" class="sidebar-link">文章目录</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React深入系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>多端开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器和网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器策略</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端安全</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/article/前端安全/从网络协议的角度聊一聊最近Github被大规模攻击事件.html" class="sidebar-link">从网络协议的角度聊一聊最近Github被大规模攻击事件</a></li><li><a href="/blog/article/前端安全/依赖安全漏洞.html" class="active sidebar-link">前端依赖安全漏洞</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#从一个安全漏洞说起" class="sidebar-link">从一个安全漏洞说起</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#安全调查" class="sidebar-link">安全调查</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#npm-audit" class="sidebar-link">npm audit</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#github-安全板块" class="sidebar-link">GitHub 安全板块</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#安全漏洞修复策略" class="sidebar-link">安全漏洞修复策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#直接依赖漏洞" class="sidebar-link">直接依赖漏洞</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#间接依赖漏洞" class="sidebar-link">间接依赖漏洞</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#强制修复漏洞" class="sidebar-link">强制修复漏洞</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#不可修复漏洞" class="sidebar-link">不可修复漏洞</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#关闭安全检查" class="sidebar-link">关闭安全检查</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#解读依赖漏洞报告" class="sidebar-link">解读依赖漏洞报告</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#漏洞数据总览" class="sidebar-link">漏洞数据总览</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#修复策略" class="sidebar-link">修复策略</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#漏洞详情" class="sidebar-link">漏洞详情</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#安全平台" class="sidebar-link">安全平台</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#hackerone" class="sidebar-link">HackerOne</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#snyk" class="sidebar-link">Snyk</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#cve" class="sidebar-link">CVE</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#参考" class="sidebar-link">参考</a></li><li class="sidebar-sub-header"><a href="/blog/article/前端安全/依赖安全漏洞.html#小结" class="sidebar-link">小结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>效果</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>博客搭建</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>综合</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>技术圈</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="从一个安全漏洞说起"><a href="#从一个安全漏洞说起" class="header-anchor">#</a> 从一个安全漏洞说起</h2> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200110220126.png" alt=""></p> <p><code>Lodash</code> 是一款非常流行的 <code>npm</code> 库，每月的下载量超过 <code>8000</code> 万次，<code>GitHub</code> 上使用它的项目有超过 <code>400</code> 万。前段时间 <code>Lodash</code> 的一个安全漏洞刷爆了朋友圈，我们先来回忆下这个安全漏洞：</p> <p>攻击者可以通过 <code>Lodash</code> 的一些函数覆盖或污染应用程序。例如：通过 <code>Lodash</code> 库中的函数 <code>defaultsDeep</code> 可以修改 <code>Object.prototype</code> 的属性。</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200113200703.png" alt=""></p> <p>我们都知道，<code>JavaScript</code> 在读取对象中的某个属性时，如果查找不到就会去其原型链上查找。试想一下，如果被修改的属性是 <code>toString</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token string">'{&quot;constructor&quot;: {&quot;prototype&quot;: {&quot;toString&quot;: true}}}'</span>
_<span class="token punctuation">.</span><span class="token function">defaultsDeep</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>每个对象都有一个 <code>toString()</code> 方法，当该对象被表示为一个文本值时，或者一个对象以预期的字符串方式引用时自动调用。默认情况下，<code>toString()</code> 方法被每个 <code>Object</code> 对象继承。如果此方法在自定义对象中未被覆盖，<code>toString()</code> 返回 <code>[object type]</code>，其中 <code>type</code> 是对象的类型。如果覆盖了 <code>toString()</code> 方法，那么给应用带来的影响就是非常大的。</p> <p>其实上述的问题就属于一个很常见的安全漏洞 —— 原型污染</p> <blockquote><p>原型污染：攻击者通过某种手段修改 JavaScript 对象的原型（prototype）</p></blockquote> <p>然而这并不是 <code>Lodash</code> 第一次爆出安全漏洞了。事实上，像这样的安全漏洞还可能存在于我们使用的千千万万个不同的开源依赖中，如果我们平时不重视他们，一旦出现问题对我们的项目造成的损失是不可估计的。这相当于你的项目中埋着很多不知道什么时候就会爆炸的炸弹。</p> <h2 id="安全调查"><a href="#安全调查" class="header-anchor">#</a> 安全调查</h2> <p>其实开发人员对开源代码的安全性的信任程度要大于对自己编写的代码的安全性的信任程度，但是在确保代码安全性和质量的工具还有很多不足之处。在 <code>npm</code> 还没有一个完善的安全检测机制之前，<code>npm</code> 和 <code>NodeJs</code> 团队曾经对数万名 <code>JavaScript</code> 开发者发起过一个调查，第一个问题就是安全问题，具体就是开发人员如何看待他们编写的代码和所使用的开源项目的安全性。</p> <p>调查结果显示：全球 <code>97％</code> 的 <code>JavaScript</code> 开发人员在自己开发的项目中都依赖开源代码，<code>77％</code> 的开发人员对他们使用的开源代码是否安全表示担忧。更有趣的是，有 <code>87％</code> 的人表示担心自己的代码的安全性。</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200110203942.png" alt=""></p> <p>另外，超过一半的 <code>JavaScript</code> 开发人员认为，他们用来评估开源代码的安全性和质量的工具还不够好。</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200110203842.png" alt=""></p> <h2 id="npm-audit"><a href="#npm-audit" class="header-anchor">#</a> npm audit</h2> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200110204627.png" alt=""></p> <p>基于上面的不太乐观的调查结果，<code>npm@6</code> 增加了一项重大更新：<code>npm audit</code> 命令。从上面的 <code>logo</code> 就可以看出，这个版本是主打安全性。 <code>npm audit</code> 命令会递归地分析依赖关系树以识别不安全的依赖，如果你在项目中使用了具有已知安全问题的依赖，就收到警告通知。该命令会在你更新或者安装了新的依赖包后自动运行。</p> <p><code>npm</code> 官方专门维护了一个漏洞列表，当开发者或者专业的安全团队发现某个依赖包存在安全问题后就会上报给 <code>npm</code> 官方，然后官方会通知该项目开发者进行修复，修复完成后 <code>npm</code> 会把漏洞详细的描述信息、解决方案发布出来：</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200110214554.png" alt=""></p> <p><code>npm aduit</code> 主要做的就是把需要检查的依赖信息发送给一个官方检查接口, 该结构会在历史上报的漏洞数据库中判断当前依赖信息是否含有漏洞，然后生成一个包含包名称、漏洞严重性、简介、路径等的漏洞报告反馈给开发者。</p> <p>我们现在直接安装一个具有安全漏洞的 <code>lodash@4.17.4</code> 版本，可见安装完成后会提醒你你刚刚增加的依赖中含有3个漏洞。</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200110211841.png" alt=""></p> <p>执行 <code>npm audit</code> 我们可以看到漏洞详情，这个版本的 <code>lodash</code> 存在3个安全漏洞，我们来具体看一个：</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200110211506.png" alt=""></p> <ul><li><code>High</code>: 表安全漏洞等级</li> <li><code>Package</code>: 存在漏洞的包名称</li> <li><code>Dependency of</code>: 当前工程直接依赖的包名称</li> <li><code>Path</code>: 漏洞完整依赖路径</li> <li><code>More info</code>: 漏洞详情</li></ul> <p>这里注意，并不只是直接依赖的包具有漏洞才会收到提醒，而是只要是你的依赖树中某一个节点依赖依赖了具有漏洞的包你就会收到提醒，来看看下面的例子：</p> <p>项目中并非直接依赖了 <code>lodash</code> ，而是 <code>@commitlint/cli</code> 依赖的 <code>@commitlint/load</code> 中依赖了 <code>lodash</code> 就会算作一个漏洞，所以一些庞大的迭代周期很长的项目含有几万个安全漏洞也是很正常的。</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200110212911.png" alt=""></p> <p>点开漏洞详情的链接：<code>https://www.npmjs.com/advisories/1065</code></p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200110213751.png" alt=""></p> <p>我们可以看到漏洞具体说明，以及解决方法，右侧是该漏洞的具体上报时间，漏洞公开时间。</p> <h2 id="github-安全板块"><a href="#github-安全板块" class="header-anchor">#</a> GitHub 安全板块</h2> <p>平时我们可能经常会收到类似如下的 <code>GitHub</code> 安全漏洞提醒的邮件。</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114105350.png" alt=""></p> <p>打开链接，我们可以看到漏洞具体的详情页面：</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114105639.png" alt=""></p> <p><code>GitHub</code> 单独为它开辟了一个，<code>Security</code> 板块来展示 <code>GitHub</code> 检测到的依赖安全漏洞，可见这些漏洞是足够引起大家重视并且需要快速修复的：</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114105922.png" alt=""></p> <p>另外，<code>GitHub</code> 还为每个可修复的漏洞提供了一键修复的功能，点击 <code>Automated security updates</code> 按钮，<code>GitHub</code> 会自动将这些依赖漏洞修复，并提交一个 <code>Pull Request</code> 给你的仓库：</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114110721.png" alt=""></p> <h2 id="安全漏洞修复策略"><a href="#安全漏洞修复策略" class="header-anchor">#</a> 安全漏洞修复策略</h2> <p><code>npm</code> 也提供了 <code>npm audit fix</code> 命令来帮助我们自动修复漏洞，还继续使用上面的例子， <code>Lodash</code> 在 <code>4.17.12</code> 版本之前都具有原型污染漏洞，下面我们来看看具体的修复策略：</p> <h3 id="直接依赖漏洞"><a href="#直接依赖漏洞" class="header-anchor">#</a> 直接依赖漏洞</h3> <p>当前我们直接依赖了一个具有安全漏洞的 <code>lodash@4.17.4</code> 版本：</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;lodash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.17.4&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>由于 <code>^4.17.4</code> 的依赖范围是 <code>&gt;=3.0.3 &lt; 4.0.0</code>，已修复的版本 <code>4.17.12</code> 在这个范围内，那么实际上 <code>npm audit fix</code> 执行的逻辑就是 <code>npm update lodash@4.17.12</code>。</p> <div class="language- extra-class"><pre class="language-text"><code>lodash@^4.17.4 -&gt; lodash@^4.17.12
</code></pre></div><h3 id="间接依赖漏洞"><a href="#间接依赖漏洞" class="header-anchor">#</a> 间接依赖漏洞</h3> <p>假设我们现在的依赖路径非常深： <code>@commitlint/cli^7.1.2&gt;@commitlint/load^1.0.1&gt;lodash^3.0.0</code></p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200110212911.png" alt=""></p> <p>因为 <code>@commitlint/load</code> 对 <code>lodash</code> 的依赖是<code>^3.0.0(&gt;=3.0.0 &lt;4.0.0)</code>，<code>4.17.12</code> 不在这个范围，所以我们不能直接通过升级 <code>Lodash</code> 来修复漏洞，这时我们就要向上层依赖进行分析。</p> <p>假设此时 <code>@commitlint/load</code> 有一个更新版本 <code>@commitlint/load^1.0.2</code> 对 <code>lodash</code> 的依赖是<code>^4.0.0(&gt;=4.0.0 &lt;5.0.0)</code>，<code>lodash@4.17.12</code> 在这个依赖范围内，那么修复策略为 <code>npm update @commitlint/load@1.0.2 --depth=2</code>。</p> <blockquote><p>npm update 只会检查更新顶层的依赖，更新更深层次的依赖版本需要使用 --depth 指定更新的深度。</p></blockquote> <p>按照这个逻辑，如果 <code>@commitlint/load</code> 也没有找到可以升级的包，那么再到上层依赖查找，直到找到可以修复漏洞的那个层级的依赖。</p> <h3 id="强制修复漏洞"><a href="#强制修复漏洞" class="header-anchor">#</a> 强制修复漏洞</h3> <p>按照上面的策略，从底层依赖一直向上层查找，如果一直到最上层依赖才有符合要求的修复版本，那么就直接 <code>npm update</code> 更新最顶层依赖。</p> <p>继续使用上面的例子，如果 <code>@commitlint/cli^7.1.2( &gt;=7.1.2 &lt;8.0.0 )</code> 还不能找到一个可修复的版本，那么 <code>npm audit fix</code> 这个命令就无能为力了。</p> <p>这时我们可以尝试 <code>npm audit fix --force</code>（强制执行 audit fix 安装最新的依赖项（toplevel））来进行修复，这个逻辑就是：<code>npm install @commitlint/cli@patchedVersion --save</code></p> <blockquote><p>这个命令会直接跨越当前指定的 <code>semver</code> 版本范围，强制将依赖更新到最新版本，一定要谨慎使用。</p></blockquote> <p>npm 还提供了一些其他的修复命令命令</p> <ul><li><code>npm audit fix --package-lock-only</code>：在不修改 <code>node_modules</code> 的情况下执行 <code>audit fix</code>，仍然会更改 <code>pkglock</code></li> <li><code>npm audit fix --only=prod</code>：跳过更新 <code>devDependencies</code></li></ul> <h3 id="不可修复漏洞"><a href="#不可修复漏洞" class="header-anchor">#</a> 不可修复漏洞</h3> <p>当然，以上的修复策略都不能解决这个安全漏洞，那说明此漏洞是无法自动修复的，需要人工判定处理。</p> <h2 id="关闭安全检查"><a href="#关闭安全检查" class="header-anchor">#</a> 关闭安全检查</h2> <p>如果你对这些安全漏洞不 care，你也可以手动指定一些配置来关闭这些安全检查：</p> <ul><li>安装单个包关闭安全审查: <code>npm install example-package-name --no-audit</code></li> <li>安装所有包关闭安全审查 - 运行 <code>npm set audit false</code></li> <li>手动将 <code>~/.npmrc</code> 配置文件中的 <code>audit</code> 修改为 <code>false</code></li></ul> <blockquote><p>当然，强烈不推荐这么做，一定要对自己开发的项目负责到底～</p></blockquote> <h2 id="解读依赖漏洞报告"><a href="#解读依赖漏洞报告" class="header-anchor">#</a> 解读依赖漏洞报告</h2> <p>执行 <code>npm audit --json</code> 将会打印出一个详细的 <code>json</code> 格式的安全报告，在这个报告里可以看到这些漏洞的详情，以及具体的漏洞修复策略。</p> <p>由于这个 <code>JSON</code> 比较大，我就不直接贴在这里了，大家可以选择一个项目到本地执行 <code>npm audit --json</code> 查看。</p> <h3 id="漏洞数据总览"><a href="#漏洞数据总览" class="header-anchor">#</a> 漏洞数据总览</h3> <p>在 <code>metadata</code> 属性中：我们可以看到漏洞检查的数据总览：</p> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token punctuation">{</span>
    <span class="token property">&quot;vulnerabilities&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;info&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;low&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;moderate&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token property">&quot;high&quot;</span><span class="token operator">:</span> <span class="token number">29</span><span class="token punctuation">,</span>
      <span class="token property">&quot;critical&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token number">18594</span><span class="token punctuation">,</span>
    <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token number">891090</span><span class="token punctuation">,</span>
    <span class="token property">&quot;optionalDependencies&quot;</span><span class="token operator">:</span> <span class="token number">9514</span><span class="token punctuation">,</span>
    <span class="token property">&quot;peerDependencies&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;totalDependencies&quot;</span><span class="token operator">:</span> <span class="token number">909785</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>vulnerabilities</code> 中展示了每种等级漏洞的数量，<code>info</code>、<code>low</code>、<code>moderate</code>、<code>high</code>、<code>critical</code> 从左到右对应的安全漏洞等级从低到高。</p> <p>下面是每种依赖的检测数量，就是我们熟悉的 <code>dependencies</code>、<code>devDependencies</code> 等等。</p> <h3 id="修复策略"><a href="#修复策略" class="header-anchor">#</a> 修复策略</h3> <p>在 <code>actions</code> 属性中，会列出所有可漏洞的修复策略，例如下面的，对 <code>@commitlint/load</code> 执行更新，深度为 <code>2</code> ，以修复 <code>@commitlint/cli&gt;@commitlint/load&gt;lodash</code> 这条路径上的漏洞：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
      <span class="token property">&quot;action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@commitlint/load&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.2&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;resolves&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1184</span><span class="token punctuation">,</span>
          <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@commitlint/cli&gt;@commitlint/load&gt;lodash&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">&quot;bundled&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;depth&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>另外，<code>action</code> 还有我们上面提到的其他几种操作：</p> <ul><li><code>install</code>(修复直接依赖)</li> <li><code>install major</code>(强制升级依赖，跨越主版本)</li> <li><code>review</code>(不可自动修复，需要人工review)</li></ul> <h3 id="漏洞详情"><a href="#漏洞详情" class="header-anchor">#</a> 漏洞详情</h3> <p><code>advisories</code> 属性存放了每个漏洞的详情：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;1065&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;cves&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;CVE-2019-10744&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;access&quot;</span><span class="token operator">:</span> <span class="token string">&quot;public&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;severity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;high&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;metadata&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;reviewers&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;confirmors&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1065</span><span class="token punctuation">,</span>
      <span class="token property">&quot;repo_from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Prototype Pollution&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;module_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lodash&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;found_by_link&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;found_by_user_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Snyk Security Team&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;reported_by_link&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;reported_by_user_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Snyk Security Team&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;vulnerable_versions&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;4.17.12&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;patched_versions&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&gt;=4.17.12&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;overview&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Versions of `lodash` before 4.17.12 are vulnerable to Prototype Pollution.  The function `defaultsDeep` allows a malicious user to modify the prototype of `Object` via `{constructor: {prototype: {...}}}` causing the addition or modification of an existing property that will exist on all objects.\n\n&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;recommendation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Update to version 4.17.12 or later.&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;references&quot;</span><span class="token operator">:</span> <span class="token string">&quot;- [Snyk Advisory](https://snyk.io/vuln/SNYK-JS-LODASH-450202)&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;cwe&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CWE-471&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://npmjs.com/advisories/1065&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;gmt_create&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-07-16T02:28:32.000Z&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;gmt_modified&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-09-11T04:49:11.000Z&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;deleted_at&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;findings&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.17.11&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;paths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;@commitlint/cli&gt;@commitlint/load&gt;@commitlint/rules&gt;@commitlint/ensure&gt;lodash&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;@commitlint/cli&gt;@commitlint/load&gt;lodash&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;@commitlint/cli&gt;@commitlint/load&gt;@commitlint/resolve-extends&gt;lodash&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;@commitlint/cli&gt;@commitlint/load&gt;lodash&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;@commitlint/cli&gt;lodash&quot;</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">&quot;bundled&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>由于属性比较多，我们挑几个重点的来看看：</p> <ul><li><code>cves</code>：CVE漏洞编号</li> <li><code>severity</code>：漏洞等级</li> <li><code>found_by_user_name</code>：发现该漏洞的用户（这里 <code>Snyk Security Team</code> 是一个知名的安全团队）</li> <li><code>vulnerable_versions</code>：受影响的版本</li> <li><code>patched_versions</code>：已修复的版本</li> <li><code>findings</code>：所有依赖此路径的漏洞</li> <li><code>overview</code>：漏洞的简要说明，这里就提到了 <code>Lodash</code> 的 <code>defaultsDeep</code> 容易收到原型污染</li> <li><code>references</code>：漏洞参考，一般是由某些专业安全平台发布的报告</li></ul> <h3 id="安全平台"><a href="#安全平台" class="header-anchor">#</a> 安全平台</h3> <p>上面的报告中提到了几个专业的安全平台，容易让人产生迷惑，我们下面来具体看一下：</p> <h3 id="hackerone"><a href="#hackerone" class="header-anchor">#</a> HackerOne</h3> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114114809.png" alt=""></p> <p><code>HackerOne（http://hackerone.com）</code>成立于 <code>2012</code> 年，是一个安全漏洞聚合和披露平台，黑客可以在网站上披露自己发现的安全漏洞、并报告给相关的网站或公司，这些网站或公司在确认后可以给黑客提供奖金等各类感谢。<code>HackerOne</code> 平台的注册黑客人数已突破 <code>30</code> 万人，提交的有效漏洞总计超过 <code>10</code> 万个，支付的漏洞奖励金超过 <code>4200</code> 万美元。</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114125341.png" alt=""></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;references&quot;</span><span class="token operator">:</span> <span class="token string">&quot;- [HackerOne Report](https://hackerone.com/reports/541502)&quot;</span>
</code></pre></div><p>我们可以在安全报告中看到，某些漏洞还会有一份 <code>HackerOne</code> 的漏洞报告做为参考。</p> <h3 id="snyk"><a href="#snyk" class="header-anchor">#</a> Snyk</h3> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114123346.png" alt=""></p> <p><code>Snyk</code> 是用于多个开发堆栈的依赖关系分析平台，涵盖 <code>JavaScript，Java，.Net，Ruby，Python，PHP，Golang</code> 和 <code>Scala</code>。 <code>Snyk</code> 维护着一个全面的，开放源代码漏洞数据库，其中包括 <code>Snyk</code> 自己的专门研究团队发现的漏洞，以及从公共数据源跟踪的漏洞。</p> <p><code>Snyk</code> 的漏洞数据库通过其威胁情报系统提供有关漏洞的全面数据，提供更好的覆盖范围，并能够显示和报告尚未收到 <code>CVE</code> 的漏洞。例如，<code>npm</code> 提示的漏洞中有 <code>72％</code> 是先被添加到 <code>Snyk</code> 数据库里的。</p> <p><code>Snyk</code> 同样也提供了扫描安全漏洞的机制，相比 <code>npm audit</code>，它的优势是可以很容易和 <code>GitHub</code> 或 <code>GitLab</code> 的 <code>CI</code> 流程集成在一起，更多扫描机制上的对比，可以看看这篇文章：<code>https://www.nearform.com/blog/comparing-npm-audit-with-snyk/</code>。</p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114125211.png" alt=""></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;references&quot;</span><span class="token operator">:</span> <span class="token string">&quot;- [Snyk Advisory](https://snyk.io/vuln/SNYK-JS-LODASH-450202)&quot;</span>
</code></pre></div><p>我们可以在上面的安全报告中看到，某些漏洞还会有一份 <code>Snyk</code> 的漏洞报告做为参考，并且 <code>Lodash</code> 这个安全漏洞也是由 <code>Snyk</code> 安全团队发现并上报的。</p> <h3 id="cve"><a href="#cve" class="header-anchor">#</a> CVE</h3> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114114711.png" alt=""></p> <p><code>CVE</code> 代表着通用漏洞和披露的标准, 这是一个由联邦政府赞助的研究和开发中心的非营利组织。它的目的是识别软件或固件中的漏洞并将其编目到一个免费的数据库中, 以提高组织的安全性。</p> <p>用 <code>CVE ID</code> 标识特定漏洞或暴露, 组织可以快速准确地从各种 <code>CVE</code> 兼容的信息源中获取信息。通过在不同安全工具和服务之间的进行比对, <code>CVE</code> 可以帮助组织选择最适合其需要的内容。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;cves&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;CVE-2019-10744&quot;</span>
      <span class="token punctuation">]</span>
</code></pre></div><p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114130016.png" alt=""></p> <p><img src="https://lsqimg-1257917459.cos.ap-beijing.myqcloud.com/20200114130100.png" alt=""></p> <p>我们可以看到，不论是上面的 <code>npm audit</code> 报告还是 <code>Snyk</code>、<code>HackerOne</code> 等其他的安全平台的报告都会附上一个漏洞的 <code>CVE</code> 编号。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li>https://medium.com/npm-inc/security-in-the-js-community-4bac032e553b</li> <li>https://zhuanlan.zhihu.com/p/73186974</li> <li>https://zhuanlan.zhihu.com/p/27891196</li> <li>http://eux.baidu.com/blog/fe/npm%20aduit%E4%BA%8C%E4%B8%89%E4%BA%8B</li></ul> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>希望看完本篇文章能对你有如下帮助：</p> <ul><li>了解依赖安全漏洞的背景</li> <li>了解 <code>npm</code> 自动修复安全漏洞的机制</li> <li>了解一些常规的安全知识，提高对前端安全问题的关注度</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/article/前端安全/从网络协议的角度聊一聊最近Github被大规模攻击事件.html" class="prev">
        从网络协议的角度聊一聊最近Github被大规模攻击事件
      </a></span> <span class="next"><a href="/blog/article/前端工程化/前端开发者必备的nginx知识.html">
        前端开发者必备的nginx知识
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.d7b4ca64.js" defer></script><script src="/blog/assets/js/2.d2cb7039.js" defer></script><script src="/blog/assets/js/19.7ca76503.js" defer></script>
  </body>
</html>
